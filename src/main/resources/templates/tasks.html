<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Modern ToDo with Calendar</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        body, html { height: 100%; }
        .app-container { display: flex; height: 100vh; }
        aside.sidebar {
          width: 280px;
          background: #f8f9fa;
          padding: 1.5rem;
          border-right: 1px solid #dee2e6;
          overflow-y: auto;
        }
        main.main-content {
          flex-grow: 1;
          padding: 1.5rem;
          display: flex;
          flex-direction: column;
          overflow-y: auto;
        }
        #calendar {
          display: grid;
          grid-template-columns: repeat(7, 1fr);
          gap: 5px;
          margin-bottom: 1rem;
          user-select: none;
        }
        .calendar-day {
          border: 1px solid #dee2e6;
          padding: 0.5rem;
          text-align: center;
          cursor: pointer;
          border-radius: 0.25rem;
          background: white;
          transition: background-color 0.2s ease;
          position: relative;
        }
        .calendar-day:hover {
          background-color: #e9ecef;
        }
        .calendar-day.selected {
          background-color: #0d6efd;
          color: white;
          font-weight: 600;
        }
        .calendar-day .task-count {
          position: absolute;
          bottom: 4px;
          right: 6px;
          background: #198754;
          color: white;
          font-size: 0.7rem;
          padding: 2px 6px;
          border-radius: 10px;
        }
        .task-completed {
          text-decoration: line-through;
          color: #6c757d;
        }
        .task-buttons button {
          margin-left: 5px;
        }
    </style>
</head>
<body>
<div class="app-container">
    <aside class="sidebar">
        <h4>Create New Task</h4>
        <form id="taskForm" th:action="@{/tasks}" method="post" th:object="${newTask}">
            <div class="mb-3">
                <label for="title" class="form-label">Task Title</label>
                <input type="text" th:field="*{title}" id="title" name="title" class="form-control" placeholder="Task title" required />
            </div>
            <div class="mb-3">
                <label for="dueDate" class="form-label">Due Date</label>
                <input type="date" th:field="*{dueDate}" id="dueDate" name="dueDate" class="form-control" required />
            </div>
            <button type="submit" class="btn btn-primary w-100">Add Task</button>
        </form>
        <hr />
        <button id="filterAll" class="btn btn-outline-primary w-100 mb-2 active">All Tasks</button>
        <button id="filterToday" class="btn btn-outline-primary w-100 mb-2">Today</button>
        <button id="filterUpcoming" class="btn btn-outline-primary w-100">Upcoming</button>
    </aside>

    <main class="main-content">
        <h4>Calendar - <span id="monthYear"></span></h4>
        <div id="calendar"></div>

        <h5>Tasks for <span id="selectedDateDisplay">Select a date</span></h5>
        <ul class="list-group" id="taskList"></ul>
    </main>
</div>

<script>
    // Simulate tasks from backend (replace this with Thymeleaf variable)
    // Expected format: [{id, title, dueDate: "YYYY-MM-DD", completed}]
    let tasks = /*[[${tasks}]]*/ [];

    // For demo purpose: you can replace this array with Thymeleaf injected tasks
    // Example data:
    // let tasks = [
    //   { id: 1, title: "Buy groceries", dueDate: "2025-05-30", completed: false },
    //   { id: 2, title: "Finish report", dueDate: "2025-06-02", completed: true },
    //   { id: 3, title: "Meeting with team", dueDate: "2025-06-02", completed: false },
    // ];

    const calendar = document.getElementById('calendar');
    const taskList = document.getElementById('taskList');
    const selectedDateDisplay = document.getElementById('selectedDateDisplay');
    const monthYearDisplay = document.getElementById('monthYear');
    const filterButtons = {
      all: document.getElementById('filterAll'),
      today: document.getElementById('filterToday'),
      upcoming: document.getElementById('filterUpcoming')
    };

    let selectedDate = null;
    let currentDate = new Date();

    // Utility: Format date to YYYY-MM-DD
    function formatDate(date) {
      return date.toISOString().split('T')[0];
    }

    // Render calendar for current month
    function renderCalendar(date) {
      calendar.innerHTML = '';
      const year = date.getFullYear();
      const month = date.getMonth();
      monthYearDisplay.textContent = date.toLocaleString('default', { month: 'long', year: 'numeric' });

      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startDayOfWeek = firstDay.getDay(); // Sunday=0 ... Saturday=6
      const totalDays = lastDay.getDate();

      // Show weekday headers
      const weekdays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      weekdays.forEach(day => {
        const header = document.createElement('div');
        header.textContent = day;
        header.style.fontWeight = '600';
        header.style.textAlign = 'center';
        calendar.appendChild(header);
      });

      // Fill blank cells before first day (Sunday based)
      for(let i = 0; i < startDayOfWeek; i++) {
        const emptyCell = document.createElement('div');
        calendar.appendChild(emptyCell);
      }

      // Fill days with date numbers
      for(let dayNum = 1; dayNum <= totalDays; dayNum++) {
        const dayDiv = document.createElement('div');
        dayDiv.classList.add('calendar-day');
        dayDiv.textContent = dayNum;

        const fullDate = new Date(year, month, dayNum);
        const fullDateString = formatDate(fullDate);

        // Count tasks for this day
        const tasksForDay = tasks.filter(t => t.dueDate === fullDateString);
        if (tasksForDay.length > 0) {
          const countBadge = document.createElement('div');
          countBadge.className = 'task-count';
          countBadge.textContent = tasksForDay.length;
          dayDiv.appendChild(countBadge);
        }

        if (selectedDate === fullDateString) {
          dayDiv.classList.add('selected');
        }

        dayDiv.addEventListener('click', () => {
          selectedDate = fullDateString;
          renderCalendar(date);
          renderTasksForSelectedDate();
        });

        calendar.appendChild(dayDiv);
      }
    }

    // Render tasks for the selected date
    function renderTasksForSelectedDate() {
      taskList.innerHTML = '';
      if (!selectedDate) {
        selectedDateDisplay.textContent = 'Select a date';
        return;
      }
      selectedDateDisplay.textContent = new Date(selectedDate).toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

      const filteredTasks = tasks.filter(t => t.dueDate === selectedDate);
      if (filteredTasks.length === 0) {
        const noTaskItem = document.createElement('li');
        noTaskItem.className = 'list-group-item text-center fst-italic';
        noTaskItem.textContent = 'No tasks for this day.';
        taskList.appendChild(noTaskItem);
        return;
      }

      filteredTasks.forEach(task => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';

        const titleSpan = document.createElement('span');
        titleSpan.textContent = task.title;
        if(task.completed) titleSpan.classList.add('task-completed');

        const buttonsDiv = document.createElement('div');
        buttonsDiv.className = 'task-buttons';

        if(!task.completed) {
          const completeBtn = document.createElement('button');
          completeBtn.className = 'btn btn-success btn-sm';
          completeBtn.textContent = 'Complete';
          completeBtn.onclick = () => markTaskComplete(task.id);
          buttonsDiv.appendChild(completeBtn);
        }

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn btn-danger btn-sm';
        deleteBtn.textContent = 'Delete';
        deleteBtn.onclick = () => deleteTask(task.id);

        buttonsDiv.appendChild(deleteBtn);
        li.appendChild(titleSpan);
        li.appendChild(buttonsDiv);

        taskList.appendChild(li);
      });
    }

    // Mark task complete - here you'd call backend API or submit form
    function markTaskComplete(taskId) {
      // For demo, just update local array
      const task = tasks.find(t => t.id === taskId);
      if(task) {
        task.completed = true;
        renderTasksForSelectedDate();
        renderCalendar(currentDate);
      }
      // TODO: send POST request to `/tasks/complete/{id}` in real app
    }

    // Delete task - here you'd call backend API or submit form
    function deleteTask(taskId) {
      // For demo, just remove from local array
      tasks = tasks.filter(t => t.id !== taskId);
      renderTasksForSelectedDate();
      renderCalendar(currentDate);
      // TODO: send POST request to `/tasks/delete/{id}` in real app
    }

    // Filter buttons (optional)
    filterButtons.all.onclick = () => {
      filterButtons.all.classList.add('active');
      filterButtons.today.classList.remove('active');
      filterButtons.upcoming.classList.remove('active');
      selectedDate = null;
      renderCalendar(currentDate);
      taskList.innerHTML = '';
      selectedDateDisplay.textContent = 'All tasks';
      renderAllTasksList();
    };

    filterButtons.today.onclick = () => {
      filterButtons.today.classList.add('active');
      filterButtons.all.classList.remove('active');
      filterButtons.upcoming.classList.remove('active');
      selectedDate = formatDate(new Date());
      renderCalendar(currentDate);
      renderTasksForSelectedDate();
    };

    filterButtons.upcoming.onclick = () => {
      filterButtons.upcoming.classList.add('active');
      filterButtons.all.classList.remove('active');
      filterButtons.today.classList.remove('active');
      selectedDate = null;
      renderCalendar(currentDate);
      taskList.innerHTML = '';
      selectedDateDisplay.textContent = 'Upcoming tasks';
      renderUpcomingTasksList();
    };

    // Render all tasks list (when "All Tasks" selected)
    function renderAllTasksList() {
      taskList.innerHTML = '';
      if(tasks.length === 0) {
        const noTaskItem = document.createElement('li');
        noTaskItem.className = 'list-group-item text-center fst-italic';
        noTaskItem.textContent = 'No tasks available.';
        taskList.appendChild(noTaskItem);
        return;
      }
      tasks.forEach(task => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';

        const titleSpan = document.createElement('span');
        titleSpan.textContent = `${task.title} (Due: ${task.dueDate})`;
        if(task.completed) titleSpan.classList.add('task-completed');

        const buttonsDiv = document.createElement('div');
        buttonsDiv.className = 'task-buttons';

        if(!task.completed) {
          const completeBtn = document.createElement('button');
          completeBtn.className = 'btn btn-success btn-sm';
          completeBtn.textContent = 'Complete';
          completeBtn.onclick = () => markTaskComplete(task.id);
          buttonsDiv.appendChild(completeBtn);
        }

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn btn-danger btn-sm';
        deleteBtn.textContent = 'Delete';
        deleteBtn.onclick = () => deleteTask(task.id);

        buttonsDiv.appendChild(deleteBtn);
        li.appendChild(titleSpan);
        li.appendChild(buttonsDiv);

        taskList.appendChild(li);
      });
    }

    // Render upcoming tasks (due after today)
    function renderUpcomingTasksList() {
      taskList.innerHTML = '';
      const todayStr = formatDate(new Date());
      const upcomingTasks = tasks.filter(t => t.dueDate > todayStr);
      if(upcomingTasks.length === 0) {
        const noTaskItem = document.createElement('li');
        noTaskItem.className = 'list-group-item text-center fst-italic';
        noTaskItem.textContent = 'No upcoming tasks.';
        taskList.appendChild(noTaskItem);
        return;
      }
      upcomingTasks.forEach(task => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';

        const titleSpan = document.createElement('span');
        titleSpan.textContent = `${task.title} (Due: ${task.dueDate})`;
        if(task.completed) titleSpan.classList.add('task-completed');

        const buttonsDiv = document.createElement('div');
        buttonsDiv.className = 'task-buttons';

        if(!task.completed) {
          const completeBtn = document.createElement('button');
          completeBtn.className = 'btn btn-success btn-sm';
          completeBtn.textContent = 'Complete';
          completeBtn.onclick = () => markTaskComplete(task.id);
          buttonsDiv.appendChild(completeBtn);
        }

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn btn-danger btn-sm';
        deleteBtn.textContent = 'Delete';
        deleteBtn.onclick = () => deleteTask(task.id);

        buttonsDiv.appendChild(deleteBtn);
        li.appendChild(titleSpan);
        li.appendChild(buttonsDiv);

        taskList.appendChild(li);
      });
    }

    // Initialize page
    function init() {
      renderCalendar(currentDate);
      filterButtons.all.click(); // Show all tasks by default
    }

    init();

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>